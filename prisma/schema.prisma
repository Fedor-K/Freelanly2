generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTH (NextAuth.js v5)
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  image         String?

  // Auth (password for migrated users, null for magic link only)
  password      String?   // bcrypt hash from old system

  // Stripe integration
  stripeId            String?   @unique
  stripeSubscriptionId String?  // Active subscription ID
  plan                Plan      @default(FREE)
  subscriptionEndsAt  DateTime? // When current period ends

  // Limits tracking
  jobViewsToday Int       @default(0)
  lastViewReset DateTime  @default(now())

  // Resume URL (user's resume link)
  resumeUrl     String?

  // Relations
  accounts      Account[]
  sessions      Session[]
  applications  Application[]
  savedJobs     SavedJob[]
  jobAlerts     JobAlert[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// NextAuth Account (for OAuth providers)
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

// NextAuth Session (for database sessions)
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// NextAuth Verification Token (for magic link)
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum Plan {
  FREE
  PRO
  ENTERPRISE
}

// ============================================
// COMPANIES
// ============================================

model Company {
  id            String       @id @default(cuid())
  slug          String       @unique
  name          String
  logo          String?
  website       String?
  description   String?

  // Company details
  size          CompanySize?
  industry      String?
  foundedYear   Int?
  headquarters  String?

  // LinkedIn
  linkedinUrl   String?
  linkedinId    String?

  // ATS integration
  atsType       ATSType?
  atsId         String?      // board token for ATS

  // Verification
  verified      Boolean      @default(false)

  // Relations
  jobs          Job[]

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([slug])
  @@index([name])
}

enum CompanySize {
  STARTUP      // 1-10
  SMALL        // 11-50
  MEDIUM       // 51-200
  LARGE        // 201-1000
  ENTERPRISE   // 1000+
}

enum ATSType {
  GREENHOUSE
  LEVER
  ASHBY
  WORKABLE
  BAMBOO
  JOBVITE
  SMARTRECRUITERS
}

// ============================================
// CATEGORIES
// ============================================

model Category {
  id            String      @id @default(cuid())
  slug          String      @unique
  name          String
  description   String?     // SEO description
  icon          String?     // Icon name or emoji

  // Hierarchy
  parentId      String?
  parent        Category?   @relation("SubCategories", fields: [parentId], references: [id])
  children      Category[]  @relation("SubCategories")

  // SEO
  metaTitle     String?
  metaDescription String?

  // Stats (updated daily)
  jobCount      Int         @default(0)
  avgSalary     Int?

  // Relations
  jobs          Job[]

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([slug])
  @@index([parentId])
}

// ============================================
// JOBS
// ============================================

model Job {
  id            String      @id @default(cuid())
  slug          String      @unique

  // Basic info
  title         String
  description   String      // Original description or post text

  // Company
  company       Company     @relation(fields: [companyId], references: [id])
  companyId     String

  // Category
  category      Category    @relation(fields: [categoryId], references: [id])
  categoryId    String

  // Location
  location      String?     // "Remote", "New York, USA", etc
  locationType  LocationType @default(REMOTE)
  country       String?     // ISO code: "US", "DE", etc
  city          String?
  timezone      String?     // "PST", "CET", etc

  // Job details
  level         Level       @default(MID)
  type          JobType     @default(FULL_TIME)

  // Salary
  salaryMin     Int?
  salaryMax     Int?
  salaryCurrency String?    @default("USD")
  salaryPeriod  SalaryPeriod @default(YEAR)
  salaryIsEstimate Boolean  @default(false)

  // Skills/tags
  skills        String[]    // ["React", "TypeScript", "Node.js"]
  benefits      String[]    // ["Health insurance", "401k", "Remote"]

  // Translation-specific fields (only for translation category jobs)
  translationTypes   TranslationType[]  // Types of translation work
  sourceLanguages    String[]           // ISO codes: ["EN", "ES", "DE"]
  targetLanguages    String[]           // ISO codes: ["RU", "FR", "ZH"]

  // Source tracking
  source        Source
  sourceType    SourceType  @default(STRUCTURED)
  sourceUrl     String      // Original URL
  sourceId      String?     // ID in source system

  // LinkedIn-specific (for posts)
  originalContent String?   // Original post text
  authorLinkedIn  String?   // Post author's LinkedIn URL
  authorName      String?   // Post author name

  // Application
  applyUrl      String?     // Direct apply URL
  applyEmail    String?     // Email to apply

  // Processing status
  enrichmentStatus EnrichmentStatus @default(COMPLETED)
  qualityScore     Int       @default(50)
  companyVerified  Boolean   @default(false)

  // Visibility
  isActive      Boolean     @default(true)
  isFeatured    Boolean     @default(false)

  // Dates
  postedAt      DateTime
  expiresAt     DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  applications  Application[]
  savedBy       SavedJob[]
  alertNotifications AlertNotification[]

  @@index([categoryId])
  @@index([companyId])
  @@index([postedAt(sort: Desc)])
  @@index([isActive, postedAt(sort: Desc)])
  @@index([source])
  @@index([level])
  @@index([locationType])
  @@index([country])
}

enum LocationType {
  REMOTE        // Fully remote, worldwide
  REMOTE_US     // Remote, US only
  REMOTE_EU     // Remote, Europe only
  REMOTE_COUNTRY // Remote, specific country
  HYBRID        // Hybrid
  ONSITE        // On-site only
}

enum Level {
  INTERN
  ENTRY
  JUNIOR
  MID
  SENIOR
  LEAD
  MANAGER
  DIRECTOR
  EXECUTIVE
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  FREELANCE
  INTERNSHIP
  TEMPORARY
}

enum SalaryPeriod {
  HOUR
  DAY
  WEEK
  MONTH
  YEAR
  ONE_TIME
}

enum Source {
  LINKEDIN          // LinkedIn posts (via Apify)
  GREENHOUSE        // Greenhouse ATS
  LEVER             // Lever ATS
  ASHBY             // Ashby ATS
  WORKABLE          // Workable ATS
  BAMBOO            // BambooHR
  SMARTRECRUITERS   // SmartRecruiters
  WORKDAY           // Workday
  RSS               // RSS feeds
  MANUAL            // Manually added
  SCRAPE            // Web scraping
  REMOTEOK          // RemoteOK API
  WEWORKREMOTELY    // WeWorkRemotely
  HACKERNEWS        // HackerNews Who is Hiring
  REMOTIVE          // Remotive API
  ARBEITNOW         // Arbeitnow API
  HIMALAYAS         // Himalayas API
  WORKINGNOMADS     // WorkingNomads
  INDEED            // Indeed API
}

enum SourceType {
  STRUCTURED    // From ATS with full data
  UNSTRUCTURED  // From LinkedIn posts, needs extraction
}

enum EnrichmentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// Translation-specific enums for language professionals
enum TranslationType {
  WRITTEN         // Written translation
  INTERPRETATION  // Oral/verbal interpretation
  LOCALIZATION    // Software/content localization
  EDITING         // Editing/proofreading
  TRANSCRIPTION   // Audio/video transcription
  SUBTITLING      // Subtitling/captioning
  MT_POST_EDITING // Machine translation post-editing
  COPYWRITING     // Multilingual copywriting
}

// ============================================
// APPLICATIONS
// ============================================

model Application {
  id            String    @id @default(cuid())

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String

  job           Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)
  jobId         String

  // Application content
  coverLetter   String?
  resumeUrl     String?

  // Status tracking
  status        ApplicationStatus @default(SENT)

  // Email tracking
  emailMessageId String?  // For tracking

  // Timestamps
  sentAt        DateTime  @default(now())
  openedAt      DateTime?
  repliedAt     DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([userId, jobId])
  @@index([userId])
  @@index([jobId])
  @@index([status])
}

enum ApplicationStatus {
  DRAFT
  SENT
  DELIVERED
  OPENED
  CLICKED
  REPLIED
  REJECTED
  INTERVIEW
  OFFER
  HIRED
  WITHDRAWN
}

// ============================================
// SAVED JOBS
// ============================================

model SavedJob {
  id        String   @id @default(cuid())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String

  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  jobId     String

  notes     String?

  createdAt DateTime @default(now())

  @@unique([userId, jobId])
  @@index([userId])
}

// ============================================
// SEO LANDING PAGES
// ============================================

model LandingPage {
  id            String    @id @default(cuid())
  slug          String    @unique

  // Filters that define this page
  categorySlug  String?
  location      String?
  level         String?
  jobType       String?

  // SEO content
  title         String
  h1            String
  metaDescription String
  content       String?   // Additional page content for SEO

  // Stats (updated via cron)
  jobCount      Int       @default(0)
  avgSalary     Int?

  // Control
  isActive      Boolean   @default(true)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([slug])
  @@index([categorySlug])
}

// ============================================
// JOB ALERTS / SUBSCRIBERS
// ============================================

model JobAlert {
  id            String    @id @default(cuid())
  email         String

  // User relation (optional - can be anonymous or linked to user)
  user          User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String?

  // Preferences
  category      String?   // Category slug filter
  keywords      String?   // Keywords to match
  country       String?   // Country filter
  level         String?   // Level filter (JUNIOR, MID, SENIOR)
  frequency     AlertFrequency @default(DAILY)

  // Translation-specific: multiple language pairs per alert
  languagePairs AlertLanguagePair[]

  // Notifications sent
  notifications AlertNotification[]

  // Status
  isActive      Boolean   @default(true)

  // Stats
  lastSentAt    DateTime?
  emailsSent    Int       @default(0)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([userId, email, category, keywords]) // Prevent duplicate alerts
  @@index([email])
  @@index([userId])
  @@index([isActive])
}

// Language pair for translation job alerts
// Example: user wants alerts for Written EN→RU, Written EN→DE, Interpretation DE→RU
model AlertLanguagePair {
  id              String    @id @default(cuid())

  jobAlert        JobAlert  @relation(fields: [jobAlertId], references: [id], onDelete: Cascade)
  jobAlertId      String

  translationType String    // WRITTEN, INTERPRETATION, LOCALIZATION, etc.
  sourceLanguage  String    // ISO 639-1: EN, RU, DE
  targetLanguage  String    // ISO 639-1: RU, EN, DE

  createdAt       DateTime  @default(now())

  @@unique([jobAlertId, translationType, sourceLanguage, targetLanguage])
  @@index([jobAlertId])
}

enum AlertFrequency {
  INSTANT   // Send immediately when new job matches
  DAILY     // Daily digest
  WEEKLY    // Weekly digest
}

// Track which jobs have been sent to which alerts (to prevent duplicates)
model AlertNotification {
  id          String    @id @default(cuid())

  jobAlert    JobAlert  @relation(fields: [jobAlertId], references: [id], onDelete: Cascade)
  jobAlertId  String

  job         Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)
  jobId       String

  sentAt      DateTime  @default(now())

  @@unique([jobAlertId, jobId])  // Prevent sending same job twice to same alert
  @@index([jobAlertId])
  @@index([jobId])
}

// ============================================
// JOB IMPORT TRACKING
// ============================================

model ImportLog {
  id            String    @id @default(cuid())

  source        Source
  status        ImportStatus @default(RUNNING)

  // Stats
  totalFetched  Int       @default(0)
  totalNew      Int       @default(0)
  totalUpdated  Int       @default(0)
  totalSkipped  Int       @default(0)
  totalFailed   Int       @default(0)

  // Error tracking
  errors        Json?     // Array of error messages

  startedAt     DateTime  @default(now())
  completedAt   DateTime?

  @@index([source])
  @@index([startedAt(sort: Desc)])
}

enum ImportStatus {
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

// ============================================
// DATA SOURCES
// ============================================

model DataSource {
  id            String       @id @default(cuid())

  // Display info
  name          String       // "Appen", "Netflix", "RemoteOK"

  // Source type
  sourceType    Source       // LEVER, GREENHOUSE, REMOTEOK, etc.

  // For ATS sources - company identifier
  companySlug   String?      // "appen", "netflix" (null for aggregators)

  // API configuration
  apiUrl        String?      // Full API URL (auto-generated or custom)
  apiKey        String?      // API key if needed
  config        Json?        // Additional settings

  // Status
  isActive      Boolean      @default(true)

  // Stats
  lastRunAt     DateTime?
  lastSuccessAt DateTime?
  totalImported Int          @default(0)
  lastError     String?
  errorCount    Int          @default(0)

  // Rate limiting
  minInterval   Int          @default(3600) // Min seconds between runs

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@unique([sourceType, companySlug]) // Can't have duplicate company for same ATS
  @@index([sourceType])
  @@index([isActive])
}

// ============================================
// SALARY BENCHMARKS (Cache for salary market data)
// ============================================

model SalaryBenchmark {
  id            String   @id @default(cuid())

  // Search key - normalized job title + location
  jobTitle      String   // Normalized title (e.g., "software engineer")
  country       String   // ISO code: "US", "UK", "DE", etc.
  region        String   @default("") // State/region for more specific data (empty = national)

  // Salary data (annual, in USD)
  minSalary     Int
  maxSalary     Int
  avgSalary     Int
  medianSalary  Int
  percentile25  Int
  percentile75  Int
  sampleSize    Int      // Number of data points used

  // Source tracking
  source        SalarySource
  sourceCode    String?  // BLS SOC code, Adzuna category, etc.
  rawResponse   Json?    // Original API response for debugging

  // Cache management
  createdAt     DateTime @default(now())
  expiresAt     DateTime // When this cache entry expires

  @@unique([jobTitle, country, region])
  @@index([jobTitle])
  @@index([country])
  @@index([expiresAt])
}

enum SalarySource {
  BLS           // US Bureau of Labor Statistics
  ADZUNA        // Adzuna salary predictor
  CALCULATED    // Calculated from our job database
  ESTIMATED     // AI/coefficient-based estimation
}

// ============================================
// SETTINGS (Key-Value Store)
// ============================================

model Settings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt

  @@index([key])
}

// ============================================
// CEO ANALYTICS - Metrics & KPIs
// ============================================

model DailyMetric {
  id        String   @id @default(cuid())
  date      DateTime @db.Date // YYYY-MM-DD

  // === TRAFFIC METRICS ===
  pageViews        Int @default(0)
  uniqueVisitors   Int @default(0)
  jobPageViews     Int @default(0)
  companyPageViews Int @default(0)

  // === USER METRICS ===
  newSignups       Int @default(0)
  activeUsers      Int @default(0)  // Users who visited
  returningUsers   Int @default(0)

  // === CONVERSION METRICS ===
  trialStarts      Int @default(0)
  paidConversions  Int @default(0)
  churns           Int @default(0)

  // === REVENUE METRICS (in cents) ===
  newMRR           Int @default(0)  // New subscriptions
  churnedMRR       Int @default(0)  // Lost from churns
  expansionMRR     Int @default(0)  // Upgrades
  netMRR           Int @default(0)  // End of day MRR

  // === ENGAGEMENT METRICS ===
  jobApplications  Int @default(0)
  savedJobs        Int @default(0)
  emailAlertSubs   Int @default(0)

  // === CONTENT METRICS ===
  newJobs          Int @default(0)
  expiredJobs      Int @default(0)
  newCompanies     Int @default(0)

  // === SEO METRICS ===
  googleImpressions Int @default(0)
  googleClicks      Int @default(0)
  indexedPages      Int @default(0)

  // === OPERATIONAL METRICS ===
  importRuns       Int @default(0)
  importSuccesses  Int @default(0)
  importFailures   Int @default(0)
  apiCostsCents    Int @default(0)  // Apify, DeepSeek, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([date])
  @@index([date])
}

model MonthlyTarget {
  id        String   @id @default(cuid())
  month     DateTime @db.Date // First day of month

  // === REVENUE TARGETS ===
  targetMRR        Int      // Target MRR in cents
  actualMRR        Int?     // Actual MRR achieved

  // === GROWTH TARGETS ===
  targetSignups    Int
  actualSignups    Int?

  targetPaidUsers  Int
  actualPaidUsers  Int?

  targetJobs       Int
  actualJobs       Int?

  // === NOTES ===
  notes            String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([month])
}

model RevenueEvent {
  id        String   @id @default(cuid())

  // Event type
  type      RevenueEventType

  // Amount in cents
  amount    Int
  currency  String   @default("USD")

  // Related entities
  userId    String?
  planFrom  Plan?
  planTo    Plan?

  // Stripe reference
  stripeEventId     String?   @unique
  stripeCustomerId  String?
  stripeSubscriptionId String?

  // Metadata
  metadata  Json?

  createdAt DateTime @default(now())

  @@index([type])
  @@index([createdAt])
  @@index([userId])
}

enum RevenueEventType {
  SUBSCRIPTION_STARTED
  SUBSCRIPTION_RENEWED
  SUBSCRIPTION_UPGRADED
  SUBSCRIPTION_DOWNGRADED
  SUBSCRIPTION_CANCELLED
  SUBSCRIPTION_CHURNED
  ONE_TIME_PAYMENT
  REFUND
}

model CEOAlert {
  id        String   @id @default(cuid())

  type      AlertType
  severity  AlertSeverity

  title     String
  message   String

  // For metrics-based alerts
  metricName String?
  threshold  Float?
  actualValue Float?

  // Status
  isRead    Boolean  @default(false)
  isDismissed Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([isRead])
  @@index([severity])
  @@index([createdAt])
}

enum AlertType {
  REVENUE_DROP
  CHURN_SPIKE
  CONVERSION_DROP
  TRAFFIC_ANOMALY
  SYSTEM_ERROR
  MILESTONE_REACHED
  TARGET_AT_RISK
  OPPORTUNITY
}

enum AlertSeverity {
  INFO
  WARNING
  CRITICAL
}
